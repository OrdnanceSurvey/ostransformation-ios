require './scripts/OCUnit2JUnit/ocunit2junit'
require './scripts/build'
require './scripts/simhelper'
require 'socket'

class String
  def self.colorize(text, color_code)
      "\e[#{color_code}m#{text}\e[0m"
  end

  def cyan
    self.class.colorize(self, 36)
  end

  def green
    self.class.colorize(self, 32)
  end

  def red
    self.class.colorize(self, 31)
  end
end

IS_WORKSPACE=false

# Parse the test output
def parse_test_output_for_result(result)
  output = File.read "build_output"
  report = ReportParser.new output

  fail "** REPORT PARSE FAILED **" unless report.exit_code

  if report.failed_test_case_count > 0
    fail "** TESTS FAILED **".red
  else
    puts "** TESTS PASSED **".green
  end
end

# Run tests using xcodebuild
def run_tests(coverage=nil)
  scheme_name = coverage == nil ? "OSGridPointConversion" : "OSGridPointConversion"
  return BuildHelper.xcodebuild "OSGridPointConversion.xcodeproj", IS_WORKSPACE, scheme_name, "iphonesimulator", "clean build test", "-destination 'platform=iOS Simulator,name=iPhone 5'"
end

# Run and parse tests. Preferred method to run tests
# and can be used if the ssh/sumulator bug gets fixed
desc 'Run unit tests'
task :test, :coverage do |t, args|
  puts '=== TEST ==='.cyan
  result = run_tests args[:coverage]
  parse_test_output_for_result result
  BuildHelper.parse_coverage unless args[:coverage] == nil
end

desc 'Run static analysis'
task :analyze do |t|
  builder = BuildHelper.new "OSGridPointConversion", IS_WORKSPACE
  fail "** STATIC ANALYSIS HAS ISSUES **".red unless builder.analyze
end
